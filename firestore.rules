rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // Helper Functions
    // ============================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user document from users collection
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check user role
    function hasRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    // Check if user has minimum role level
    // Role hierarchy: Owner > Admin > Operator > Viewer
    function hasMinRole(minRole) {
      let userRole = getUserData().role;
      return isAuthenticated() && (
        userRole == 'Owner' ||
        (minRole == 'Admin' && userRole in ['Owner', 'Admin']) ||
        (minRole == 'Operator' && userRole in ['Owner', 'Admin', 'Operator']) ||
        (minRole == 'Viewer' && userRole in ['Owner', 'Admin', 'Operator', 'Viewer'])
      );
    }
    
    // Check if user is Owner or Admin
    function isAdminOrOwner() {
      return hasMinRole('Admin');
    }
    
    // Check if user can write (Operator and above)
    function canWrite() {
      return hasMinRole('Operator');
    }
    
    // Check if user can read (all authenticated users)
    function canRead() {
      return hasMinRole('Viewer');
    }
    
    // ============================================================================
    // Inventory Collection Rules
    // ============================================================================
    
    match /inventory/{itemId} {
      // Anyone authenticated can read inventory
      allow read: if canRead();
      
      // Operators and above can create/update inventory
      allow create, update: if canWrite();
      
      // Only Admins and Owners can delete inventory
      allow delete: if isAdminOrOwner();
    }
    
    // ============================================================================
    // Users Collection Rules
    // ============================================================================
    
    match /users/{userId} {
      // Users can read their own profile
      // Admins and Owners can read all profiles
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || isAdminOrOwner());
      
      // Only Owners can create/update/delete users
      allow create, update, delete: if hasRole('Owner');
      
      // Users can update their own profile (except role)
      allow update: if isAuthenticated() && 
        request.auth.uid == userId && 
        !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
    }
    
    // ============================================================================
    // WMS Suppliers Collection Rules
    // ============================================================================

    match /wms_suppliers/{supplierId} {
      // Anyone authenticated can read suppliers
      allow read: if canRead();

      // Operators and above can create/update suppliers
      allow create, update: if canWrite();

      // Only Admins and Owners can delete suppliers
      allow delete: if isAdminOrOwner();
    }

    // ============================================================================
    // Sales Orders Collection Rules
    // ============================================================================

    match /sales_orders/{orderId} {
      // Customers can read their own orders, Admins/Owners can read all
      allow read: if isAuthenticated() && (
        isAdminOrOwner() ||
        resource.data.createdBy == request.auth.token.email
      );

      // Customers can create orders, Operators and above can create/update
      allow create: if isAuthenticated();
      allow update: if canWrite() || resource.data.createdBy == request.auth.token.email;

      // Only Admins and Owners can delete orders
      allow delete: if isAdminOrOwner();
    }

    // ============================================================================
    // Customers Collection Rules
    // ============================================================================

    match /customers/{customerId} {
      // Anyone authenticated can read customers
      allow read: if canRead();

      // Operators and above can create/update customers
      // Customers can also create/update their own profile
      allow create: if isAuthenticated();
      allow update: if canWrite() || resource.data.email == request.auth.token.email;

      // Only Admins and Owners can delete customers
      allow delete: if isAdminOrOwner();
    }

    // ============================================================================
    // Shipments Collection Rules
    // ============================================================================

    match /shipments/{shipmentId} {
      // Anyone authenticated can read shipments
      allow read: if canRead();

      // Operators and above can create/update/delete shipments
      allow create, update: if canWrite();
      allow delete: if isAdminOrOwner();
    }

    // ============================================================================
    // Payment Transactions Collection Rules
    // ============================================================================

    match /payment_transactions/{paymentId} {
      // Anyone authenticated can read payments
      allow read: if canRead();

      // Operators and above can create/update payments
      allow create, update: if canWrite();

      // Only Admins and Owners can delete payments
      allow delete: if isAdminOrOwner();
    }

    // ============================================================================
    // Notifications Collection Rules
    // ============================================================================

    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if isAuthenticated();

      // Anyone authenticated can create notifications
      allow create: if isAuthenticated();

      // Users can update/delete their own notifications
      allow update, delete: if isAuthenticated();
    }

    // ============================================================================
    // Development/Testing Rules (REMOVE IN PRODUCTION)
    // ============================================================================

    // Temporarily allow all operations for development
    // IMPORTANT: Remove or comment out these rules before deploying to production!
    match /inventory/{itemId} {
      allow read, write: if true;
    }

    match /users/{userId} {
      allow read, write: if true;
    }

    match /wms_suppliers/{supplierId} {
      allow read, write: if true;
    }

    match /sales_orders/{orderId} {
      allow read, write: if true;
    }

    match /customers/{customerId} {
      allow read, write: if true;
    }

    match /shipments/{shipmentId} {
      allow read, write: if true;
    }

    match /payment_transactions/{paymentId} {
      allow read, write: if true;
    }

    match /notifications/{notificationId} {
      allow read, write: if true;
    }
  }
}

