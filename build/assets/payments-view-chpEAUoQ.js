import{i as ls,r as c,H as cs,j as e,B as p,D as de,Y as me,v as ue,w as he,x as pe,y as xe,z as ye,C as F,m as O,n as B,o as L,bs as je,_ as os,I as v,d as ge,bt as ds,l as ms,am as us,K as l,L as j,bu as hs,bv as ps,bw as xs,t as ys,bx as js,by as gs,bz as Ns,bA as fs,bB as bs}from"./index-BZFfDCt8.js";import{g as vs,h as se}from"./permissions-BqDqHH54.js";import{u as Cs,a as Ds,P as Ss,F as Ps,B as ws,T as Ts,E as Is,c as ks,b as As}from"./bulk-delete-dialog-D3pOJQT_.js";import{S as U,a as _,b as W,c as q,d as K,T as Ne,e as Ms,f as Fs,g as fe,h as be,i as g,j as Os,k as u}from"./sortable-table-head-BF5dfTj4.js";import{D as Bs}from"./download-DrkCTtrf.js";import{D as Ls}from"./dollar-sign-CFG76bNL.js";import{B as Ks,C as Es}from"./credit-card-DDnkfb4v.js";import{a as ae,A as te}from"./archive-CXgcdQkM.js";import"./skeleton-tmMuzZD5.js";const ve=["Cash","Bank Transfer","Credit Card","Check","Online Payment"],E=w=>new Intl.NumberFormat("en-PH",{style:"currency",currency:"PHP"}).format(w);function Ys(){const{user:w}=ls(),T=w?vs(w.id):"Viewer",Y=se(T,"purchase_orders:create"),Ce=se(T,"purchase_orders:update"),De=se(T,"purchase_orders:delete"),re=T==="Owner"||T==="Admin",[Se,N]=c.useState(null),[ne,Pe]=c.useState([]),[G,we]=c.useState([]),[Te,Ie]=c.useState(!0),[ie,ke]=c.useState(""),D=cs(ie,300),[R,Ae]=c.useState("all"),[m,Me]=c.useState(!1),[Fe,V]=c.useState(!1),[Oe,$]=c.useState(null),[Be,J]=c.useState(!1),[o,le]=c.useState(null),[I,Q]=c.useState("asc"),[t,f]=c.useState({trxDate:new Date().toISOString().split("T")[0],supplierId:"",supplierName:"",country:"",city:"",poId:"",billNumber:"",paymentMode:"Cash",amountPaid:0,notes:""});c.useEffect(()=>{(async()=>{try{const[a,r,n]=await Promise.all([ds(),ms(),us()]);N(a),Pe(r),we(n)}catch{l.error("Failed to load data")}finally{Ie(!1)}})()},[]);const z=Se??[],k=c.useMemo(()=>z.filter(s=>{const a=s.archived===!0;if(m!==a)return!1;const r=!D||s.id.toLowerCase().includes(D.toLowerCase())||s.supplierName.toLowerCase().includes(D.toLowerCase())||s.poId.toLowerCase().includes(D.toLowerCase())||s.billNumber.toLowerCase().includes(D.toLowerCase()),n=R==="all"||s.paymentMode===R;return r&&n}),[z,D,R,m]),Le=c.useMemo(()=>o?[...k].sort((s,a)=>{const r=s[o],n=a[o];if(r==null&&n==null)return 0;if(r==null)return 1;if(n==null)return-1;if(typeof r=="number"&&typeof n=="number")return I==="asc"?r-n:n-r;const C=String(r).toLowerCase(),b=String(n).toLowerCase();return I==="asc"?C.localeCompare(b):b.localeCompare(C)}):k,[k,o,I]),{currentPage:Ke,totalPages:Ee,paginatedData:X,goToPage:Re,itemsPerPage:Ve,totalItems:$e}=Cs(Le,10),{selectedIds:S,isSelected:ce,toggleItem:ze,toggleAll:He,deselectAll:A,isAllSelected:Ue,isPartiallySelected:_e,selectionCount:M,hasSelection:We}=Ds(X),P=c.useMemo(()=>{const s=z.filter(i=>!i.archived),a=s.length,r=s.reduce((i,h)=>i+h.amountPaid,0),n=s.filter(i=>i.paymentMode==="Cash").reduce((i,h)=>i+h.amountPaid,0),C=s.filter(i=>i.paymentMode==="Bank Transfer").reduce((i,h)=>i+h.amountPaid,0),b=s.filter(i=>i.paymentMode==="Credit Card").reduce((i,h)=>i+h.amountPaid,0),d=s.filter(i=>i.paymentMode==="Check").reduce((i,h)=>i+h.amountPaid,0),Z=s.filter(i=>i.paymentMode==="Online Payment").reduce((i,h)=>i+h.amountPaid,0),ee=new Date;ee.setDate(ee.getDate()-7);const is=s.filter(i=>new Date(i.createdAt)>=ee).length;return{totalTransactions:a,totalAmount:r,cashTotal:n,bankTotal:C,cardTotal:b,checkTotal:d,onlineTotal:Z,newThisWeek:is,avgTransactionAmount:a>0?r/a:0}},[z]),x=s=>{const a=s;o===a?I==="asc"?Q("desc"):(le(null),Q("asc")):(le(a),Q("asc"))},y=s=>o===s?I:null,qe=s=>{const a={Cash:{variant:"default",className:"bg-green-500"},"Bank Transfer":{variant:"outline",className:"border-blue-500 text-blue-600"},"Credit Card":{variant:"outline",className:"border-purple-500 text-purple-600"},Check:{variant:"outline",className:"border-orange-500 text-orange-600"},"Online Payment":{variant:"outline",className:"border-cyan-500 text-cyan-600"}},{variant:r,className:n}=a[s];return e.jsx(ys,{variant:r,className:ge("gap-1",n),children:s})},H=()=>{f({trxDate:new Date().toISOString().split("T")[0],supplierId:"",supplierName:"",country:"",city:"",poId:"",billNumber:"",paymentMode:"Cash",amountPaid:0,notes:""})},Ye=s=>{const a=G.find(r=>r.id===s);f(r=>({...r,supplierId:s,supplierName:a?.name??"",country:a?.country??"",city:a?.city??""}))},Ge=s=>{const a=ne.find(r=>r.id===s);if(a){const r=G.find(n=>n.id===a.supplierId);f(n=>({...n,poId:s,supplierId:a.supplierId,supplierName:a.supplierName,country:r?.country??"",city:r?.city??"",billNumber:a.billNumber??""}))}},Je=async()=>{if(!t.supplierId||!t.poId||t.amountPaid<=0){l.error("Please fill in all required fields");return}try{const s=await hs({trxDate:t.trxDate,supplierId:t.supplierId,supplierName:t.supplierName,country:t.country,city:t.city,poId:t.poId,billNumber:t.billNumber,paymentMode:t.paymentMode,amountPaid:t.amountPaid,notes:t.notes,createdBy:w?.id??"1"});N(a=>[s,...a??[]]),l.success(`Transaction ${s.id} created successfully`),V(!1),H()}catch(s){l.error(s instanceof Error?s.message:"Failed to create transaction")}},Qe=async s=>{if(!t.supplierId||!t.poId||t.amountPaid<=0){l.error("Please fill in all required fields");return}try{const a=await Ns({id:s,trxDate:t.trxDate,supplierId:t.supplierId,supplierName:t.supplierName,country:t.country,city:t.city,poId:t.poId,billNumber:t.billNumber,paymentMode:t.paymentMode,amountPaid:t.amountPaid,notes:t.notes});N(r=>r?.map(n=>n.id===s?a:n)??[]),l.success(`Transaction ${s} updated successfully`),$(null),H()}catch(a){l.error(a instanceof Error?a.message:"Failed to update transaction")}},Xe=async s=>{try{const a=await fs(s);N(r=>r?.map(n=>n.id===s?a:n)??[]),l.success(`Transaction ${s} archived`)}catch(a){l.error(a instanceof Error?a.message:"Failed to archive transaction")}},Ze=async s=>{try{const a=await js(s);N(r=>r?.map(n=>n.id===s?a:n)??[]),l.success(`Transaction ${s} restored`)}catch(a){l.error(a instanceof Error?a.message:"Failed to restore transaction")}},es=async s=>{try{await gs(s),N(a=>a?.filter(r=>r.id!==s)??[]),l.success(`Transaction ${s} permanently deleted`)}catch(a){l.error(a instanceof Error?a.message:"Failed to delete transaction")}},ss=async()=>{try{await xs(Array.from(S)),N(s=>s?.map(a=>S.has(a.id)?{...a,archived:!0,archivedAt:new Date().toISOString()}:a)??[]),l.success(`${M} transactions archived`),A()}catch{l.error("Failed to archive transactions")}},as=async()=>{try{await ps(Array.from(S)),N(s=>s?.map(a=>S.has(a.id)?{...a,archived:!1,archivedAt:void 0}:a)??[]),l.success(`${M} transactions restored`),A()}catch{l.error("Failed to restore transactions")}},ts=async()=>{try{await bs(Array.from(S)),N(s=>s?.filter(a=>!S.has(a.id))??[]),l.success(`${M} transactions permanently deleted`),A(),J(!1)}catch{l.error("Failed to delete transactions")}},rs=s=>{f({trxDate:s.trxDate.split("T")[0],supplierId:s.supplierId,supplierName:s.supplierName,country:s.country,city:s.city,poId:s.poId,billNumber:s.billNumber,paymentMode:s.paymentMode,amountPaid:s.amountPaid,notes:s.notes??""}),$(s.id)},ns=()=>{const s=["Trx ID","Trx Date","Supplier ID","Supplier Name","Country","City","PO ID","Bill Num","PMT Mode","Amount Paid"],a=k.map(d=>[d.id,d.trxDate.split("T")[0],d.supplierId,d.supplierName,d.country,d.city,d.poId,d.billNumber,d.paymentMode,d.amountPaid.toFixed(2)]),r=[s.join(","),...a.map(d=>d.map(Z=>`"${Z}"`).join(","))].join(`
`),n=new Blob([r],{type:"text/csv"}),C=URL.createObjectURL(n),b=document.createElement("a");b.href=C,b.download=`payment-transactions-${new Date().toISOString().split("T")[0]}.csv`,b.click(),URL.revokeObjectURL(C),l.success("Transactions exported to CSV")},oe=()=>e.jsxs("div",{className:"grid gap-4 py-4 max-h-[60vh] overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"trxDate",children:"Transaction Date *"}),e.jsx(v,{id:"trxDate",type:"date",value:t.trxDate,onChange:s=>f(a=>({...a,trxDate:s.target.value}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"poId",children:"Purchase Order *"}),e.jsxs(U,{value:t.poId,onValueChange:Ge,children:[e.jsx(_,{children:e.jsx(W,{placeholder:"Select Purchase Order"})}),e.jsx(q,{children:ne.filter(s=>!s.archived).map(s=>e.jsxs(K,{value:s.id,children:[s.id," - ",s.supplierName]},s.id))})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"supplierId",children:"Supplier *"}),e.jsxs(U,{value:t.supplierId,onValueChange:Ye,children:[e.jsx(_,{children:e.jsx(W,{placeholder:"Select Supplier"})}),e.jsx(q,{children:G.map(s=>e.jsxs(K,{value:s.id,children:[s.id," - ",s.name]},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"supplierName",children:"Supplier Name"}),e.jsx(v,{id:"supplierName",value:t.supplierName,disabled:!0,className:"bg-muted"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"country",children:"Country"}),e.jsx(v,{id:"country",value:t.country,disabled:!0,className:"bg-muted"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"city",children:"City"}),e.jsx(v,{id:"city",value:t.city,disabled:!0,className:"bg-muted"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"billNumber",children:"Bill Number"}),e.jsx(v,{id:"billNumber",value:t.billNumber,onChange:s=>f(a=>({...a,billNumber:s.target.value})),placeholder:"BILL-001"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"paymentMode",children:"Payment Mode *"}),e.jsxs(U,{value:t.paymentMode,onValueChange:s=>f(a=>({...a,paymentMode:s})),children:[e.jsx(_,{children:e.jsx(W,{})}),e.jsx(q,{children:ve.map(s=>e.jsx(K,{value:s,children:s},s))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"amountPaid",children:"Amount Paid (â‚±) *"}),e.jsx(v,{id:"amountPaid",type:"number",min:"0",step:"0.01",value:t.amountPaid,onChange:s=>f(a=>({...a,amountPaid:parseFloat(s.target.value)||0})),placeholder:"0.00"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(j,{htmlFor:"notes",children:"Notes"}),e.jsx(v,{id:"notes",value:t.notes,onChange:s=>f(a=>({...a,notes:s.target.value})),placeholder:"Optional notes..."})]})]});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Payments"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage payments against purchase orders"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",onClick:ns,disabled:k.length===0,children:[e.jsx(Bs,{className:"h-4 w-4 mr-2"}),"Export CSV"]}),Y&&e.jsxs(de,{open:Fe,onOpenChange:s=>{V(s),s||H()},children:[e.jsx(me,{asChild:!0,children:e.jsxs(p,{children:[e.jsx(Ss,{className:"h-4 w-4 mr-2"}),"New Payment"]})}),e.jsxs(ue,{className:"max-w-2xl",children:[e.jsxs(he,{children:[e.jsx(pe,{children:"Create New Payment"}),e.jsx(xe,{children:"Add a new payment against a purchase order"})]}),oe(),e.jsxs(ye,{children:[e.jsx(p,{variant:"outline",onClick:()=>V(!1),children:"Cancel"}),e.jsx(p,{onClick:Je,children:"Create Payment"})]})]})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(F,{children:[e.jsxs(O,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Total Paid"}),e.jsx(Ls,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E(P.totalAmount)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[P.totalTransactions," transactions"]})]})]}),e.jsxs(F,{children:[e.jsxs(O,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Cash Payments"}),e.jsx(Ks,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E(P.cashTotal)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Direct cash paid"})]})]}),e.jsxs(F,{children:[e.jsxs(O,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Bank Transfers"}),e.jsx(je,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E(P.bankTotal)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Bank transfers made"})]})]}),e.jsxs(F,{children:[e.jsxs(O,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(B,{className:"text-sm font-medium",children:"Card & Online"}),e.jsx(Es,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(L,{children:[e.jsx("div",{className:"text-2xl font-bold",children:E(P.cardTotal+P.onlineTotal)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Digital payments"})]})]})]}),e.jsxs(F,{children:[e.jsx(O,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(B,{className:"text-base font-medium",children:"Transactions"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs(p,{variant:m?"secondary":"outline",size:"sm",onClick:()=>{Me(!m),A()},children:[m?e.jsx(ae,{className:"h-4 w-4 mr-2"}):e.jsx(te,{className:"h-4 w-4 mr-2"}),m?"View Active":"View Archived"]})})]})}),e.jsxs(L,{children:[e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(os,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(v,{placeholder:"Search by ID, supplier, PO, or bill...",className:"pl-9",value:ie,onChange:s=>ke(s.target.value)})]}),e.jsxs(U,{value:R,onValueChange:Ae,children:[e.jsxs(_,{className:"w-[180px]",children:[e.jsx(Ps,{className:"h-4 w-4 mr-2"}),e.jsx(W,{placeholder:"Payment Mode"})]}),e.jsxs(q,{children:[e.jsx(K,{value:"all",children:"All Payment Modes"}),ve.map(s=>e.jsx(K,{value:s,children:s},s))]})]})]}),We&&e.jsx(ws,{selectionCount:M,onClearSelection:A,actions:m?[{label:"Restore",onClick:as,icon:e.jsx(ae,{className:"h-4 w-4"})},...re?[{label:"Delete Permanently",onClick:()=>J(!0),icon:e.jsx(Ne,{className:"h-4 w-4"}),variant:"destructive"}]:[]]:[{label:"Archive",onClick:ss,icon:e.jsx(te,{className:"h-4 w-4"})}]}),Te?e.jsx(Ts,{columns:10,rows:5}):X.length===0?e.jsx(Is,{icon:je,title:m?"No Archived Transactions":"No Transactions Found",description:m?"Archived transactions will appear here":"Create your first payment to get started",actionLabel:!m&&Y?"New Payment":void 0,onAction:!m&&Y?()=>V(!0):void 0}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"rounded-md border overflow-x-auto",children:e.jsxs(Ms,{children:[e.jsx(Fs,{children:e.jsxs(fe,{children:[e.jsx(be,{className:"w-12",children:e.jsx("input",{type:"checkbox",checked:Ue,ref:s=>{s&&(s.indeterminate=_e)},onChange:()=>He(),className:"h-4 w-4 rounded border-gray-300"})}),e.jsx(g,{sortKey:"trxDate",currentSortKey:o,sortDirection:y("trxDate"),onSort:x,children:"Trx Date"}),e.jsx(g,{sortKey:"id",currentSortKey:o,sortDirection:y("id"),onSort:x,children:"Trx ID"}),e.jsx(g,{sortKey:"supplierId",currentSortKey:o,sortDirection:y("supplierId"),onSort:x,children:"Supplier ID"}),e.jsx(g,{sortKey:"supplierName",currentSortKey:o,sortDirection:y("supplierName"),onSort:x,children:"Supplier Name"}),e.jsx(g,{sortKey:"country",currentSortKey:o,sortDirection:y("country"),onSort:x,children:"Country"}),e.jsx(g,{sortKey:"city",currentSortKey:o,sortDirection:y("city"),onSort:x,children:"City"}),e.jsx(g,{sortKey:"poId",currentSortKey:o,sortDirection:y("poId"),onSort:x,children:"PO ID"}),e.jsx(g,{sortKey:"billNumber",currentSortKey:o,sortDirection:y("billNumber"),onSort:x,children:"Bill Num"}),e.jsx(g,{sortKey:"paymentMode",currentSortKey:o,sortDirection:y("paymentMode"),onSort:x,children:"PMT Mode"}),e.jsx(g,{sortKey:"amountPaid",currentSortKey:o,sortDirection:y("amountPaid"),onSort:x,children:"Amount Paid"}),e.jsx(be,{className:"text-right",children:"Actions"})]})}),e.jsx(Os,{children:X.map(s=>e.jsxs(fe,{className:ge(ce(s.id)&&"bg-muted/50"),children:[e.jsx(u,{children:e.jsx("input",{type:"checkbox",checked:ce(s.id),onChange:()=>ze(s.id),className:"h-4 w-4 rounded border-gray-300"})}),e.jsx(u,{children:s.trxDate.split("T")[0]}),e.jsx(u,{className:"font-medium",children:s.id}),e.jsx(u,{children:s.supplierId}),e.jsx(u,{children:s.supplierName}),e.jsx(u,{children:s.country||"-"}),e.jsx(u,{children:s.city||"-"}),e.jsx(u,{children:s.poId}),e.jsx(u,{children:s.billNumber||"-"}),e.jsx(u,{children:qe(s.paymentMode)}),e.jsx(u,{className:"font-medium text-red-600",children:E(s.amountPaid)}),e.jsx(u,{className:"text-right",children:e.jsx("div",{className:"flex items-center justify-end gap-1",children:m?e.jsxs(e.Fragment,{children:[e.jsx(p,{size:"sm",variant:"outline",onClick:()=>Ze(s.id),title:"Restore",children:e.jsx(ae,{className:"h-4 w-4"})}),re&&e.jsx(p,{size:"sm",variant:"destructive",onClick:()=>es(s.id),title:"Delete Permanently",children:e.jsx(Ne,{className:"h-4 w-4"})})]}):e.jsxs(e.Fragment,{children:[Ce&&e.jsxs(de,{open:Oe===s.id,onOpenChange:a=>{a||($(null),H())},children:[e.jsx(me,{asChild:!0,children:e.jsx(p,{size:"sm",variant:"outline",onClick:()=>rs(s),children:"Edit"})}),e.jsxs(ue,{className:"max-w-2xl",children:[e.jsxs(he,{children:[e.jsxs(pe,{children:["Edit Payment ",s.id]}),e.jsx(xe,{children:"Update payment details"})]}),oe(),e.jsxs(ye,{children:[e.jsx(p,{variant:"outline",onClick:()=>$(null),children:"Cancel"}),e.jsx(p,{onClick:()=>Qe(s.id),children:"Save Changes"})]})]})]}),De&&e.jsx(p,{size:"sm",variant:"outline",onClick:()=>Xe(s.id),title:"Archive",children:e.jsx(te,{className:"h-4 w-4"})})]})})})]},s.id))})]})}),e.jsx(ks,{currentPage:Ke,totalPages:Ee,onPageChange:Re,totalItems:$e,itemsPerPage:Ve})]})]})]}),e.jsx(As,{open:Be,onOpenChange:J,itemCount:M,onConfirm:ts,itemType:"transactions"})]})}export{Ys as PaymentsView};
